name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (test without creating release)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          targets: x86_64-pc-windows-gnu

      - name: Install MinGW toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-mingw-target-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-mingw-target-release-

      - name: Read version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Found version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$VERSION" >> $GITHUB_OUTPUT

      - name: Read package name from Cargo.toml
        id: package
        run: |
          NAME=$(grep '^name' Cargo.toml | head -1 | sed 's/name = "\(.*\)"/\1/')
          echo "Found package name: $NAME"
          echo "NAME=$NAME" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        run: |
          TAG="${{ steps.version.outputs.TAG }}"
          git fetch --tags
          if git tag -l "$TAG" | grep -q "$TAG"; then
            echo "Error: Tag $TAG already exists! Please update version in Cargo.toml"
            exit 1
          fi
          echo "Tag $TAG does not exist, continuing..."

      - name: Build release binary
        run: |
          echo "Building release binary for Windows..."
          cargo build --release --target x86_64-pc-windows-gnu --verbose
          echo "Build completed successfully"

      - name: Prepare release artifact
        id: artifact
        run: |
          NAME="${{ steps.package.outputs.NAME }}"
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILT_EXE="target/x86_64-pc-windows-gnu/release/$NAME.exe"
          ARTIFACT_NAME="$NAME-v$VERSION.exe"
          
          if [ ! -f "$BUILT_EXE" ]; then
            echo "Error: Built executable not found at $BUILT_EXE"
            ls -la target/x86_64-pc-windows-gnu/release/
            exit 1
          fi
          
          echo "Copying $BUILT_EXE to $ARTIFACT_NAME"
          cp "$BUILT_EXE" "$ARTIFACT_NAME"
          
          # Show file size
          SIZE=$(ls -lh "$ARTIFACT_NAME" | awk '{print $5}')
          echo "Artifact size: $SIZE"
          
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "ARTIFACT_PATH=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: latest_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "Latest tag: $LATEST_TAG"
            echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "HAS_PREVIOUS_TAG=true" >> $GITHUB_OUTPUT
          else
            echo "No previous tags found"
            echo "HAS_PREVIOUS_TAG=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          TAG="${{ steps.version.outputs.TAG }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          
          if [ "${{ steps.latest_tag.outputs.HAS_PREVIOUS_TAG }}" = "true" ]; then
            LATEST_TAG="${{ steps.latest_tag.outputs.LATEST_TAG }}"
            COMPARE_URL="$REPO_URL/compare/$LATEST_TAG...$TAG"
          
            echo "Generating changelog from $LATEST_TAG to $TAG"
          
            # Get commits between tags
            CHANGELOG="**Full Changelog**: $COMPARE_URL

          "
          
            # Process commits and filter out [release] commits
            while IFS='|' read -r HASH MESSAGE; do
              # Skip commits that start with [release]
              if [[ "$MESSAGE" =~ ^\[release\] ]]; then
                echo "Skipping release commit: $MESSAGE"
                continue
              fi
          
              COMMIT_URL="$REPO_URL/commit/$HASH"
              CHANGELOG="${CHANGELOG}- [$MESSAGE]($COMMIT_URL)
          "
            done < <(git log "$LATEST_TAG..HEAD" --pretty=format:"%H|%s" --date-order)
          
          else
            echo "No previous tag found, listing all commits"
            CHANGELOG="**Initial Release**

          "
          
            # Process all commits and filter out [release] commits
            while IFS='|' read -r HASH MESSAGE; do
              # Skip commits that start with [release]
              if [[ "$MESSAGE" =~ ^\[release\] ]]; then
                echo "Skipping release commit: $MESSAGE"
                continue
              fi
          
              COMMIT_URL="$REPO_URL/commit/$HASH"
              CHANGELOG="${CHANGELOG}- [$MESSAGE]($COMMIT_URL)
          "
            done < <(git log --pretty=format:"%H|%s" --date-order)
          fi
          
          # Save to file for GitHub release
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "Changelog generated:"
          cat CHANGELOG.txt

      - name: Create Release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: ${{ steps.version.outputs.TAG }}
          body_path: CHANGELOG.txt
          files: ${{ steps.artifact.outputs.ARTIFACT_PATH }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "================================"
          echo "DRY RUN MODE - No release created"
          echo "================================"
          echo ""
          echo "Tag: ${{ steps.version.outputs.TAG }}"
          echo "Artifact: ${{ steps.artifact.outputs.ARTIFACT_NAME }}"
          echo ""
          echo "Changelog:"
          cat CHANGELOG.txt
          echo ""
          echo "To create the release, run the workflow without dry_run option"

      - name: Upload artifact for inspection
        if: ${{ inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.ARTIFACT_NAME }}
          path: ${{ steps.artifact.outputs.ARTIFACT_PATH }}
          retention-days: 1