name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (test without creating release)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          targets: x86_64-pc-windows-gnu

      - name: Install MinGW toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-mingw-target-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-mingw-target-release-

      - name: Read version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Found version: $VERSION"
          
          # Pre-release and build metadata are not supported
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Valid SemVer 2.0.0 format: $VERSION"
          else
            echo "Error: Invalid version format in Cargo.toml"
            echo "Expected: MAJOR.MINOR.PATCH"
            echo "Got: $VERSION"
            if [[ "$VERSION" =~ - ]]; then
              echo "Pre-release versions are not supported"
            fi
            if [[ "$VERSION" =~ \+ ]]; then
              echo "Build metadata is not supported"
            fi
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$VERSION" >> $GITHUB_OUTPUT

      - name: Read package name from Cargo.toml
        id: package
        run: |
          NAME=$(grep '^name' Cargo.toml | head -1 | sed 's/name = "\(.*\)"/\1/')
          echo "Found package name: $NAME"
          echo "NAME=$NAME" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        run: |
          TAG="${{ steps.version.outputs.TAG }}"
          git fetch --tags
          if git tag -l "$TAG" | grep -q "$TAG"; then
            echo "Error: Tag $TAG already exists! Please update version in Cargo.toml"
            exit 1
          fi
          echo "Tag $TAG does not exist, continuing..."

      - name: Build release binary
        run: |
          echo "Building release binary for Windows..."
          cargo build --release --target x86_64-pc-windows-gnu --verbose
          echo "Build completed successfully"

      - name: Prepare release artifact
        id: artifact
        run: |
          NAME="${{ steps.package.outputs.NAME }}"
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILT_EXE="target/x86_64-pc-windows-gnu/release/$NAME.exe"
          ARTIFACT_NAME="$NAME-v$VERSION.exe"
          
          if [ ! -f "$BUILT_EXE" ]; then
            echo "Error: Built executable not found at $BUILT_EXE"
            ls -la target/x86_64-pc-windows-gnu/release/
            exit 1
          fi
          
          echo "Copying $BUILT_EXE to $ARTIFACT_NAME"
          cp "$BUILT_EXE" "$ARTIFACT_NAME"
          
          # Show file size
          SIZE=$(ls -lh "$ARTIFACT_NAME" | awk '{print $5}')
          echo "Artifact size: $SIZE"
          
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "ARTIFACT_PATH=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: latest_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "Latest tag: $LATEST_TAG"
            echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "HAS_PREVIOUS_TAG=true" >> $GITHUB_OUTPUT
          else
            echo "No previous tags found"
            echo "HAS_PREVIOUS_TAG=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          TAG="${{ steps.version.outputs.TAG }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          
          if [ "${{ steps.latest_tag.outputs.HAS_PREVIOUS_TAG }}" = "true" ]; then
            LATEST_TAG="${{ steps.latest_tag.outputs.LATEST_TAG }}"
            COMPARE_URL="$REPO_URL/compare/$LATEST_TAG...$TAG"
          
            echo "Generating changelog from $LATEST_TAG to HEAD"
            echo "Latest tag commit:"
            git log -1 --oneline "$LATEST_TAG"
            echo ""
            echo "Current HEAD:"
            git log -1 --oneline HEAD
            echo ""
          

            CHANGELOG="**Full Changelog**: $COMPARE_URL

          "
          
            # Count total commits for debugging
            TOTAL_COMMITS=$(git rev-list "$LATEST_TAG..HEAD" --count)
            echo "Total commits between $LATEST_TAG and HEAD: $TOTAL_COMMITS"
            echo ""
          
            # Process commits with proper date ordering
            while IFS='|' read -r HASH DATE MESSAGE; do
              # Skip empty lines
              [ -z "$HASH" ] && continue
              
              # Skip commits that start with [release]
              if [[ "$MESSAGE" =~ ^\[release\] ]]; then
                echo "Skipping release commit: $MESSAGE"
                continue
              fi
          
              COMMIT_URL="$REPO_URL/commit/$HASH"
              # Format: - [commit message](link) (date)
              CHANGELOG="${CHANGELOG}- [\`${HASH:0:7}\`]($COMMIT_URL) $MESSAGE *(${DATE})*
          "
            done < <(git log "$LATEST_TAG..HEAD" --pretty=format:"%H|%cs|%s" --reverse --no-merges)
          
          else
            echo "No previous tag found, listing all commits"
            CHANGELOG="**Initial Release**

          "
          
            # Count total commits for debugging
            TOTAL_COMMITS=$(git rev-list HEAD --count)
            echo "Total commits in repository: $TOTAL_COMMITS"
            echo ""
          
            # Process all commits with proper date ordering
            while IFS='|' read -r HASH DATE MESSAGE; do
              # Skip empty lines
              [ -z "$HASH" ] && continue
              
              # Skip commits that start with [release]
              if [[ "$MESSAGE" =~ ^\[release\] ]]; then
                echo "Skipping release commit: $MESSAGE"
                continue
              fi
          
              COMMIT_URL="$REPO_URL/commit/$HASH"
              CHANGELOG="${CHANGELOG}- [\`${HASH:0:7}\`]($COMMIT_URL) $MESSAGE *(${DATE})*
          "
            done < <(git log --pretty=format:"%H|%cs|%s" --reverse --no-merges)
          fi
          
          # Save to file for GitHub release
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "Changelog generated successfully!"
          echo "================================"
          cat CHANGELOG.txt
          echo "================================"

      - name: Create Release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: ${{ steps.version.outputs.TAG }}
          body_path: CHANGELOG.txt
          files: ${{ steps.artifact.outputs.ARTIFACT_PATH }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "================================"
          echo "DRY RUN MODE - No release created"
          echo "================================"
          echo ""
          echo "Tag: ${{ steps.version.outputs.TAG }}"
          echo "Artifact: ${{ steps.artifact.outputs.ARTIFACT_NAME }}"
          echo ""
          echo "Changelog:"
          cat CHANGELOG.txt
          echo ""
          echo "To create the release, run the workflow without dry_run option"

      - name: Upload artifact for inspection
        if: ${{ inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.ARTIFACT_NAME }}
          path: ${{ steps.artifact.outputs.ARTIFACT_PATH }}
          retention-days: 1